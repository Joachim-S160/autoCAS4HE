#!/bin/bash
# Sn2 DKH2 relativistic HF calculation
# Generated by generate_dimer_tests.sh
#
#PBS -N sn2_dkh2
#PBS -A 2025_127
#PBS -l nodes=1:ppn=8
#PBS -l walltime=02:00:00
#PBS -l mem=32gb
#PBS -M joachim.scheerlinck@ugent.be
#PBS -m e

# ==============================================================================
# Setup environment
# ==============================================================================
PROJECT="starting_2025_097"
INSTALL_DIR="/dodrio/scratch/projects/${PROJECT}/autoCAS4HE_built/autoCAS4HE"
source ${INSTALL_DIR}/setup_hortense.sh
export MOLCAS_WORKDIR=$(pwd)

cd $PBS_O_WORKDIR

echo "=============================================="
echo "  Sn2 DKH2 Relativistic HF Calculation"
echo "=============================================="
echo "Working directory: $(pwd)"
echo "Date: $(date)"
echo ""

# ==============================================================================
# Run OpenMolcas SCF for both geometries
# ==============================================================================
mkdir -p sn2_0_workdir sn2_1_workdir

# Geometry 0 (equilibrium)
echo "Running Sn2 geometry 0 (equilibrium)..."
cd sn2_0_workdir
cp ../sn2_0.xyz .
cp ../sn2_0_scf.input .
export MOLCAS_WORKDIR=$(pwd)/scratch_0
mkdir -p $MOLCAS_WORKDIR
pymolcas sn2_0_scf.input > sn2_0_scf.log 2>&1
if [ -f "sn2_0_scf/sn2_0_scf.scf.h5" ]; then
    cp sn2_0_scf/sn2_0_scf.scf.h5 ../sn2_0.scf.h5
    echo "  Created sn2_0.scf.h5"
else
    echo "WARNING: Could not find scf.h5 for geometry 0"
fi
cd ..

# Geometry 1 (stretched)
echo "Running Sn2 geometry 1 (stretched)..."
cd sn2_1_workdir
cp ../sn2_1.xyz .
cp ../sn2_1_scf.input .
export MOLCAS_WORKDIR=$(pwd)/scratch_1
mkdir -p $MOLCAS_WORKDIR
pymolcas sn2_1_scf.input > sn2_1_scf.log 2>&1
if [ -f "sn2_1_scf/sn2_1_scf.scf.h5" ]; then
    cp sn2_1_scf/sn2_1_scf.scf.h5 ../sn2_1.scf.h5
    echo "  Created sn2_1.scf.h5"
else
    echo "WARNING: Could not find scf.h5 for geometry 1"
fi
cd ..

# ==============================================================================
# Run IBO distribution analysis
# ==============================================================================
echo ""
echo "Running IBO distribution analysis..."
SCRIPT_DIR="/dodrio/scratch/projects/starting_2025_097/autoCAS4HE_built/autoCAS4HE/scripts"
if [ -f "sn2_0.scf.h5" ]; then
    python3 ${SCRIPT_DIR}/IBO_distr.py sn2_0.scf.h5 --element sn
fi

echo ""
echo "=============================================="
echo "  Sn2 calculation completed!"
echo "=============================================="
echo "Date: $(date)"
