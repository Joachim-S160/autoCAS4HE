#!/bin/bash
# Po2 autoCAS Test with Pipek-Mezey Localization
# Tests PM localization as alternative to IBO for heavy elements
#
# IBO fails for Po2 due to small MINAO basis. PM doesn't rely on MINAO.
#
# Submit with: qsub po2_pm.pbs

#PBS -N po2_pm
#PBS -A 2025_127
#PBS -l nodes=1:ppn=16
#PBS -l walltime=01:00:00
#PBS -l mem=64gb

# ==============================================================================
# Setup environment
# ==============================================================================
PROJECT="starting_2025_097"
INSTALL_DIR="/dodrio/scratch/projects/${PROJECT}/autoCAS4HE_built/autoCAS4HE"
source ${INSTALL_DIR}/setup_hortense.sh
export MOLCAS_WORKDIR=$(pwd)

cd $PBS_O_WORKDIR

echo "=============================================="
echo "  Po2 autoCAS Test: Pipek-Mezey Localization"
echo "=============================================="
echo ""
echo "Working directory: $(pwd)"
echo "Date: $(date)"
echo ""
echo "Purpose: Test Pipek-Mezey (PM) localization as alternative to IBO"
echo "         for heavy elements where IBO fails due to small MINAO basis."
echo ""

# ==============================================================================
# Run autoCAS with PM localization
# ==============================================================================
echo "Running autoCAS with Pipek-Mezey localization (-L PIPEK_MEZEY)..."
echo ""

# Get absolute paths - use .scf.h5 files (HDF5 format that Serenity reads)
PO2_0_ORB="$(pwd)/po2_0.scf.h5"
PO2_1_ORB="$(pwd)/po2_1.scf.h5"

# Run autoCAS consistent active space protocol with:
# -e: Use external orbitals (DKH2 from OpenMolcas)
# -L PIPEK_MEZEY: Use Pipek-Mezey localization instead of IBO
# -u: Include unmappable orbitals in CAS (IMPORTANT: PM doesn't support virtual
#     localization, so all virtuals are unmappable. Without -u, selected virtuals
#     won't be in the combined CAS)
# -f: Force CAS selection even when single-orbital entropies indicate single-reference
# -b ANO-RCC-VDZP: Relativistic contracted basis
# -m DMRGSCF: DMRG-SCF method for heavy elements
scine_autocas_consistent_active_space -e -o "$PO2_0_ORB,$PO2_1_ORB" -L PIPEK_MEZEY -u -f -b ANO-RCC-VDZP -m DMRGSCF po2_0.xyz po2_1.xyz

EXIT_CODE=$?

echo ""
echo "=============================================="
echo "  Test completed!"
echo "=============================================="
echo ""
echo "Exit code: $EXIT_CODE"
echo "Date: $(date)"

if [ $EXIT_CODE -eq 0 ]; then
    echo "SUCCESS: Pipek-Mezey localization completed without errors!"
    echo "Check the output files for active space selection results."
else
    echo "FAILED: Pipek-Mezey localization encountered errors."
    echo "Check the log files for details."
fi
