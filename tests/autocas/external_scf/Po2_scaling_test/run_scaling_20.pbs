#!/bin/bash
# Po2 autoCAS Scaling Test: 20 geometries
# Distances: 2.10, 2.20, 2.30, 2.40, 2.50, 2.60, 2.70, 2.90, 3.00, 3.25, 3.75, 4.25, 4.75, 5.00, 6.00, 6.50, 7.00, 7.50, 8.75, 10.00 A
#
# Measures wall time, CPU time, and peak memory for autoCAS
# with 20 dissociation geometries.
#
# PREREQUISITE: Run generate_scf.pbs first to create .scf.h5 files.
# Submit with: qsub run_scaling_20.pbs

#PBS -N po2_scale_20
#PBS -A 2025_127
#PBS -l nodes=1:ppn=16
#PBS -l walltime=04:00:00
#PBS -l mem=112gb
#PBS -M joachim.scheerlinck@ugent.be
#PBS -m e

# ==============================================================================
# Setup
# ==============================================================================
PROJECT="starting_2025_097"
INSTALL_DIR="/dodrio/scratch/projects/starting_2025_097/autoCAS4HE_built/autoCAS4HE"
source ${INSTALL_DIR}/setup_hortense.sh

cd $PBS_O_WORKDIR
BASE_DIR=$(pwd)

echo "=============================================="
echo "  Po2 Scaling Test: 20 geometries"
echo "=============================================="
echo "Start time: $(date)"
echo "Distances (A): 2.10 2.20 2.30 2.40 2.50 2.60 2.70 2.90 3.00 3.25 3.75 4.25 4.75 5.00 6.00 6.50 7.00 7.50 8.75 10.00"
echo "PBS Job ID: $PBS_JOBID"
echo "Requested mem: 112gb"
echo ""

# ==============================================================================
# Check that all .scf.h5 files exist
# ==============================================================================
MISSING=0
if [ ! -f "po2_000.scf.h5" ]; then
    echo "ERROR: Missing po2_000.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_001.scf.h5" ]; then
    echo "ERROR: Missing po2_001.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_002.scf.h5" ]; then
    echo "ERROR: Missing po2_002.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_003.scf.h5" ]; then
    echo "ERROR: Missing po2_003.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_004.scf.h5" ]; then
    echo "ERROR: Missing po2_004.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_005.scf.h5" ]; then
    echo "ERROR: Missing po2_005.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_006.scf.h5" ]; then
    echo "ERROR: Missing po2_006.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_008.scf.h5" ]; then
    echo "ERROR: Missing po2_008.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_009.scf.h5" ]; then
    echo "ERROR: Missing po2_009.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_010.scf.h5" ]; then
    echo "ERROR: Missing po2_010.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_012.scf.h5" ]; then
    echo "ERROR: Missing po2_012.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_014.scf.h5" ]; then
    echo "ERROR: Missing po2_014.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_016.scf.h5" ]; then
    echo "ERROR: Missing po2_016.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_017.scf.h5" ]; then
    echo "ERROR: Missing po2_017.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_019.scf.h5" ]; then
    echo "ERROR: Missing po2_019.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_020.scf.h5" ]; then
    echo "ERROR: Missing po2_020.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_021.scf.h5" ]; then
    echo "ERROR: Missing po2_021.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_022.scf.h5" ]; then
    echo "ERROR: Missing po2_022.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_023.scf.h5" ]; then
    echo "ERROR: Missing po2_023.scf.h5"
    MISSING=$((MISSING + 1))
fi
if [ ! -f "po2_024.scf.h5" ]; then
    echo "ERROR: Missing po2_024.scf.h5"
    MISSING=$((MISSING + 1))
fi

if [ $MISSING -gt 0 ]; then
    echo "ERROR: $MISSING .scf.h5 files missing. Run generate_scf.pbs first."
    exit 1
fi
echo "All 20 .scf.h5 files found."
echo ""

# ==============================================================================
# Create dedicated workdir for this scaling level
# ==============================================================================
WORKDIR="${BASE_DIR}/workdir_N20"
rm -rf "$WORKDIR"
mkdir -p "$WORKDIR"
cd "$WORKDIR"
export MOLCAS_WORKDIR="${WORKDIR}"

echo "Working directory: $WORKDIR"
echo ""

# ==============================================================================
# Copy .scf.h5 and .xyz files into workdir (avoid concurrent HDF5 access)
# ==============================================================================
echo "Copying input files into workdir..."
cp "${BASE_DIR}/po2_000.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_000.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_001.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_001.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_002.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_002.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_003.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_003.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_004.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_004.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_005.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_005.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_006.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_006.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_008.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_008.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_009.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_009.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_010.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_010.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_012.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_012.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_014.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_014.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_016.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_016.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_017.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_017.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_019.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_019.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_020.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_020.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_021.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_021.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_022.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_022.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_023.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_023.scf.h5" "$WORKDIR/"
cp "${BASE_DIR}/po2_024.xyz" "$WORKDIR/"
cp "${BASE_DIR}/po2_024.scf.h5" "$WORKDIR/"
echo "  Copied 20 .xyz and .scf.h5 files"
echo ""

# ==============================================================================
# Build argument lists (local paths inside workdir)
# ==============================================================================
XYZ_ARGS="${WORKDIR}/po2_000.xyz ${WORKDIR}/po2_001.xyz ${WORKDIR}/po2_002.xyz ${WORKDIR}/po2_003.xyz ${WORKDIR}/po2_004.xyz ${WORKDIR}/po2_005.xyz ${WORKDIR}/po2_006.xyz ${WORKDIR}/po2_008.xyz ${WORKDIR}/po2_009.xyz ${WORKDIR}/po2_010.xyz ${WORKDIR}/po2_012.xyz ${WORKDIR}/po2_014.xyz ${WORKDIR}/po2_016.xyz ${WORKDIR}/po2_017.xyz ${WORKDIR}/po2_019.xyz ${WORKDIR}/po2_020.xyz ${WORKDIR}/po2_021.xyz ${WORKDIR}/po2_022.xyz ${WORKDIR}/po2_023.xyz ${WORKDIR}/po2_024.xyz"
ORB_PATHS="${WORKDIR}/po2_000.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_001.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_002.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_003.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_004.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_005.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_006.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_008.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_009.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_010.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_012.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_014.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_016.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_017.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_019.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_020.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_021.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_022.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_023.scf.h5"
ORB_PATHS="${ORB_PATHS},${WORKDIR}/po2_024.scf.h5"

# ==============================================================================
# Run autoCAS with timing and memory tracking
# ==============================================================================
echo "Running autoCAS with 20 geometries..."
echo ""

# Record start time
START_SECONDS=$SECONDS

# Use /usr/bin/time for peak memory measurement (maxresident in KB)
/usr/bin/time -v scine_autocas_consistent_active_space \
    -e \
    -o "$ORB_PATHS" \
    -b ANO-RCC-VDZP \
    -m DMRGSCF \
    $XYZ_ARGS \
    2> ${BASE_DIR}/timing_20.txt

EXIT_CODE=$?
ELAPSED=$((SECONDS - START_SECONDS))

# ==============================================================================
# Results
# ==============================================================================
cd "$BASE_DIR"

echo ""
echo "=============================================="
echo "  Scaling Test Results: 20 geometries"
echo "=============================================="
echo "Exit code:    $EXIT_CODE"
echo "Wall time:    ${ELAPSED}s ($((ELAPSED / 60))m $((ELAPSED % 60))s)"
echo "End time:     $(date)"
echo ""

# Extract peak memory from /usr/bin/time output
PEAK_MEM=0
if [ -f "timing_20.txt" ]; then
    PEAK_MEM=$(grep "Maximum resident" timing_20.txt | awk '{print $NF}')
    echo "Peak RSS:     ${PEAK_MEM} KB ($((PEAK_MEM / 1024)) MB)"
fi

# ==============================================================================
# Extract active space and copy output files
# ==============================================================================
if [ $EXIT_CODE -eq 0 ]; then
    FINAL_DIR="${WORKDIR}/autocas_project/final"
    RESULTS_DIR="${BASE_DIR}/results_N20"
    mkdir -p "$RESULTS_DIR"

    # Copy orbital files (.RasOrb) and HDF5 files for each geometry
    echo ""
    echo "--- Output files ---"
    if [ -d "$FINAL_DIR" ]; then
        cp "$FINAL_DIR"/system_*.RasOrb "$RESULTS_DIR/" 2>/dev/null
        cp "$FINAL_DIR"/system_*.rasscf.h5 "$RESULTS_DIR/" 2>/dev/null
        cp "$FINAL_DIR"/energies.dat "$RESULTS_DIR/" 2>/dev/null
        echo "  Copied RasOrb + rasscf.h5 + energies.dat to $RESULTS_DIR/"
        ls -la "$RESULTS_DIR/"
    else
        echo "  WARNING: $FINAL_DIR not found"
    fi

    # Extract active space info from the PBS stdout (this script's output)
    # We grep from the autoCAS stdout which is interleaved in this job's output
    echo ""
    echo "--- Active space summary ---"
    CAS_EO=$(grep -m1 "final CAS(e, o)" ${WORKDIR}/autocas_project/final/system_0.log 2>/dev/null || echo "not found")
    if [ "$CAS_EO" = "not found" ]; then
        # Fallback: check combined_cas_spaces file
        if [ -f "${WORKDIR}/autocas_project/final/combined_cas_spaces" ]; then
            echo "  Combined CAS spaces:"
            cat "${WORKDIR}/autocas_project/final/combined_cas_spaces"
            cp "${WORKDIR}/autocas_project/final/combined_cas_spaces" "$RESULTS_DIR/"
        fi
    fi

    # Extract energies
    if [ -f "$RESULTS_DIR/energies.dat" ]; then
        echo ""
        echo "--- Final energies ---"
        cat "$RESULTS_DIR/energies.dat"
    fi
fi

echo ""
echo "--- Full timing output ---"
if [ -f "timing_20.txt" ]; then
    cat timing_20.txt
fi

# Write summary to CSV-like file for easy parsing
echo "20,$EXIT_CODE,$ELAPSED,$PEAK_MEM" >> scaling_results.csv

echo ""
echo "Results appended to scaling_results.csv"
echo "Format: n_geom,exit_code,wall_time_s,peak_rss_kb"
